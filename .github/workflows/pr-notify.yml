name: PR Notify

on:
  pull_request:
    types: [closed]

jobs:
  discordNotification:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up jq
      run: sudo apt-get install -y jq

    - name: Send Discord Notification
      env:
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        PR_TITLE=$(jq -r .pull_request.title $GITHUB_EVENT_PATH)
        PR_USER=$(jq -r .pull_request.user.login $GITHUB_EVENT_PATH)
        PR_BODY=$(jq -r .pull_request.body $GITHUB_EVENT_PATH)
        PR_MERGED_AT=$(jq -r .pull_request.merged_at $GITHUB_EVENT_PATH)
        PR_MERGED_AT_DATE=$(date -d "$PR_MERGED_AT" '+%Y-%m-%d %H:%M:%S')

        TWEAKS=$(echo "$PR_BODY" | grep -oP '^-\s*tweak:.*' | sed 's/- //')
        ADDS=$(echo "$PR_BODY" | grep -oP '^-\s*add:.*' | sed 's/- //')
        FIXES=$(echo "$PR_BODY" | grep -oP '^-\s*fix:.*' | sed 's/- //')
        REMOVES=$(echo "$PR_BODY" | grep -oP '^-\s*remove:.*' | sed 's/- //')

        CHANGES=""
        [ -n "$TWEAKS" ] && CHANGES="${CHANGES}\nüõ†Ô∏è **Tweak:**\n${TWEAKS}"
        [ -n "$ADDS" ] && CHANGES="${CHANGES}\n‚ûï **Add:**\n${ADDS}"
        [ -n "$FIXES" ] && CHANGES="${CHANGES}\nüîß **Fix:**\n${FIXES}"
        [ -n "$REMOVES" ] && CHANGES="${CHANGES}\n‚ùå **Remove:**\n${REMOVES}"

        JSON_PAYLOAD=$(jq -n --arg title "–ü—Ä–∏–Ω—è—Ç PR: ${PR_TITLE}" \
                              --arg user "${PR_USER}" \
                              --arg body "${PR_BODY}" \
                              --arg changes "${CHANGES}" \
                              --arg merged_at "${PR_MERGED_AT}" \
                              --arg merged_at_date "${PR_MERGED_AT_DATE}" \
                              '{
                                "username": "Space-Cats | [Development]",
                                "avatar_url": "https://media.discordapp.net/attachments/1250152873250132073/1263212035366326363/space-cats_logo_space_1.png?ex=669b63a2&is=669a1222&hm=a99c299e22f2a48b152b83b59069004ad94dc261dcc44de03564285729f8e586&=&format=webp&quality=lossless&width=115&height=115",
                                "embeds": [{
                                  "title": $title,
                                  "description": "**–û–ø–∏—Å–∞–Ω–∏–µ:**\n\($body)\n\n**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**\($changes)",
                                  "color": 3066993,
                                  "timestamp": $merged_at,
                                  "footer": {
                                    "text": "Merged at \($merged_at_date)"
                                  },
                                  "fields": [
                                    {
                                      "name": "–°—Ç–∞—Ç—É—Å",
                                      "value": "Merged",
                                      "inline": true
                                    },
                                    {
                                      "name": "–ê–≤—Ç–æ—Ä",
                                      "value": $user,
                                      "inline": true
                                    }
                                  ]
                                }]
                              }')

        echo "$JSON_PAYLOAD"

        curl -H "Content-Type: application/json" -d "$JSON_PAYLOAD" $DISCORD_WEBHOOK_URL

